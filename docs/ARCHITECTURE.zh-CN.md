# ğŸ—ï¸ æ¶æ„æ–‡æ¡£

æœ¬æ–‡æ¡£å…¨é¢æ¦‚è¿°äº† LangGraph.js AI ä»£ç†æ¨¡æ¿çš„æ¶æ„ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…ç†è§£ç³»ç»Ÿçš„è®¾è®¡æ¨¡å¼å¹¶æ‰©å±•åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [æ•°æ®æµ](#æ•°æ®æµ)
4. [æ•°æ®åº“æ¨¡å¼](#æ•°æ®åº“æ¨¡å¼)
5. [ä»£ç†å·¥ä½œæµ](#ä»£ç†å·¥ä½œæµ)
6. [MCP é›†æˆ](#mcp-é›†æˆ)
7. [å·¥å…·å®¡æ‰¹æµç¨‹](#å·¥å…·å®¡æ‰¹æµç¨‹)
8. [æµå¼æ¶æ„](#æµå¼æ¶æ„)
9. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
10. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)

## ğŸŒ ç³»ç»Ÿæ¦‚è¿°

### é«˜çº§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   èŠå¤© UI       â”‚  â”‚   è®¾ç½® UI       â”‚  â”‚   çº¿ç¨‹åˆ—è¡¨      â”‚ â”‚
â”‚  â”‚   ç»„ä»¶          â”‚  â”‚   (MCP é…ç½®)    â”‚  â”‚   ä¾§è¾¹æ         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   React Query   â”‚  â”‚   ä¸Šä¸‹æ–‡ API    â”‚  â”‚   è‡ªå®šä¹‰ Hooks  â”‚ â”‚
â”‚  â”‚   (çŠ¶æ€ç®¡ç†)    â”‚  â”‚   (UI çŠ¶æ€)     â”‚  â”‚   (æ•°æ®é€»è¾‘)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                            HTTP/SSE
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Next.js æœåŠ¡å™¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   API è·¯ç”±      â”‚  â”‚   ä»£ç†æœåŠ¡      â”‚  â”‚   èŠå¤©æœåŠ¡      â”‚ â”‚
â”‚  â”‚   (REST/SSE)    â”‚  â”‚   (æµå¼å¤„ç†)    â”‚  â”‚   (å·¥å…·)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ä»£ç†æ„å»ºå™¨      â”‚  â”‚   MCP å®¢æˆ·ç«¯    â”‚  â”‚   å†…å­˜ç®¡ç†      â”‚ â”‚
â”‚  â”‚  (LangGraph)    â”‚  â”‚   (å·¥å…·)        â”‚  â”‚   (å†å²è®°å½•)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                          æ•°æ®åº“/ç½‘ç»œ
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¤–éƒ¨ç³»ç»Ÿ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚   OpenAI/Google â”‚  â”‚   MCP æœåŠ¡å™¨    â”‚ â”‚
â”‚  â”‚   (æŒä¹…åŒ–)      â”‚  â”‚   (LLM API)     â”‚  â”‚   (å·¥å…·)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

#### å‰ç«¯

- **Next.js 15**ï¼šåº”ç”¨è·¯ç”±ä¸æœåŠ¡å™¨ç»„ä»¶
- **React 19**ï¼šæœ€æ–°åŠŸèƒ½ï¼ŒåŒ…æ‹¬ Suspense å’Œå¹¶å‘æ¸²æŸ“
- **TypeScript**ï¼šä¸¥æ ¼æ¨¡å¼ç¡®ä¿ç±»å‹å®‰å…¨
- **Tailwind CSS**ï¼šå®ç”¨ä¼˜å…ˆçš„æ ·å¼
- **shadcn/ui**ï¼šå¯è®¿é—®çš„ç»„ä»¶åº“
- **React Query (TanStack Query)**ï¼šæœåŠ¡å™¨çŠ¶æ€ç®¡ç†

#### åç«¯

- **Node.js**ï¼šJavaScript è¿è¡Œæ—¶
- **Prisma ORM**ï¼šç±»å‹å®‰å…¨çš„æ•°æ®åº“è®¿é—®
- **PostgreSQL**ï¼šä¸»æ•°æ®åº“
- **æœåŠ¡å™¨å‘é€äº‹ä»¶**ï¼šå®æ—¶æµå¼ä¼ è¾“

#### AI ä¸å·¥å…·

- **LangGraph.js**ï¼šä»£ç†ç¼–æ’æ¡†æ¶
- **LangChain**ï¼šLLM æŠ½è±¡å’Œå·¥å…·
- **OpenAI/Google**ï¼šè¯­è¨€æ¨¡å‹æä¾›å•†
- **æ¨¡å‹ä¸Šä¸‹æ–‡åè®®**ï¼šåŠ¨æ€å·¥å…·é›†æˆ

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### 1. ä»£ç†æ„å»ºå™¨ (`src/lib/agent/builder.ts`)

AI ä»£ç†ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£åˆ›å»ºå’Œé…ç½® LangGraph StateGraphsã€‚

```typescript
export class AgentBuilder {
  private toolNode: ToolNode;
  private readonly model: BaseChatModel;
  private tools: DynamicTool[];
  private systemPrompt: string;
  private approveAllTools: boolean;
  private checkpointer?: BaseCheckpointSaver;

  build() {
    const stateGraph = new StateGraph(MessagesAnnotation);
    stateGraph
      .addNode("agent", this.callModel.bind(this))
      .addNode("tools", this.toolNode)
      .addNode("tool_approval", this.approveToolCall.bind(this))
      .addEdge(START, "agent")
      .addConditionalEdges("agent", this.shouldApproveTool.bind(this))
      .addEdge("tools", "agent");

    return stateGraph.compile({ checkpointer: this.checkpointer });
  }
}
```

**ä¸»è¦èŒè´£ï¼š**

- ä½¿ç”¨äººæœºäº¤äº’æ¨¡å¼æ„å»º StateGraph
- å·¥å…·ç»‘å®šå’Œå®¡æ‰¹å·¥ä½œæµ
- æ¨¡å‹é…ç½®å’Œæç¤ºç®¡ç†
- æ£€æŸ¥ç‚¹é›†æˆä»¥å®ç°æŒä¹…åŒ–

### 2. MCP é›†æˆ (`src/lib/agent/mcp.ts`)

ç®¡ç†æ¥è‡ªæ¨¡å‹ä¸Šä¸‹æ–‡åè®®æœåŠ¡å™¨çš„åŠ¨æ€å·¥å…·åŠ è½½ã€‚

```typescript
export async function createMCPClient(): Promise<MultiServerMCPClient | null> {
  const mcpServers = await getMCPServerConfigs(); // æ¥è‡ªæ•°æ®åº“

  if (Object.keys(mcpServers).length === 0) {
    return null;
  }

  const client = new MultiServerMCPClient({
    mcpServers: mcpServers,
    throwOnLoadError: false,
    prefixToolNameWithServerName: true, // é˜²æ­¢å†²çª
  });

  return client;
}
```

**ä¸»è¦ç‰¹æ€§ï¼š**

- æ•°æ®åº“é©±åŠ¨çš„ MCP æœåŠ¡å™¨é…ç½®
- æ”¯æŒ stdio å’Œ HTTP ä¼ è¾“
- å·¥å…·åç§°å‰ç¼€ä»¥é˜²æ­¢å†²çª
- å¤±è´¥æœåŠ¡å™¨çš„ä¼˜é›…é”™è¯¯å¤„ç†

### 3. æµå¼æœåŠ¡ (`src/services/agentService.ts`)

é€šè¿‡æœåŠ¡å™¨å‘é€äº‹ä»¶å¤„ç†ä»£ç†å“åº”çš„å®æ—¶æµå¼ä¼ è¾“ã€‚

```typescript
export async function streamResponse(params: {
  threadId: string;
  userText: string;
  opts?: MessageOptions;
}) {
  // ç¡®ä¿çº¿ç¨‹å­˜åœ¨
  await ensureThread(threadId, userText);

  // å¤„ç†å·¥å…·å®¡æ‰¹ä¸æ­£å¸¸è¾“å…¥
  const inputs = opts?.allowTool
    ? new Command({ resume: { action: opts.allowTool === "allow" ? "continue" : "update" } })
    : { messages: [new HumanMessage(userText)] };

  const agent = await ensureAgent({
    model: opts?.model,
    tools: opts?.tools,
    approveAllTools: opts?.approveAllTools,
  });

  // ä½¿ç”¨æ£€æŸ¥ç‚¹è¿›è¡Œæµå¼ä¼ è¾“ä»¥å®ç°æŒä¹…åŒ–
  const iterable = await agent.stream(inputs, {
    streamMode: ["updates"],
    configurable: { thread_id: threadId },
  });

  // å¤„ç†å¹¶äº§ç”Ÿæµå¼å—
  async function* generator(): AsyncGenerator<MessageResponse, void, unknown> {
    for await (const chunk of iterable) {
      // å¤„ç†å—å¹¶äº§ç”Ÿ MessageResponse
    }
  }

  return generator();
}
```

### 4. èŠå¤© Hook (`src/hooks/useChatThread.ts`)

æä¾›å…·æœ‰ä¹è§‚ UI æ›´æ–°çš„èŠå¤©åŠŸèƒ½çš„ React hookã€‚

```typescript
export function useChatThread({ threadId }: UseChatThreadOptions) {
  const queryClient = useQueryClient();
  const streamRef = useRef<EventSource | null>(null);

  const sendMessage = useCallback(
    async (text: string, opts?: MessageOptions) => {
      // ä¹è§‚ UIï¼šç«‹å³æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      const userMessage: MessageResponse = {
        type: "human",
        data: { id: `temp-${Date.now()}`, content: text },
      };
      queryClient.setQueryData(["messages", threadId], (old: MessageResponse[] = []) => [
        ...old,
        userMessage,
      ]);

      // æµå¼ä¼ è¾“ä»£ç†å“åº”
      await handleStreamResponse({ threadId, text, opts });
    },
    [threadId, queryClient, handleStreamResponse],
  );

  return {
    messages,
    sendMessage,
    approveToolExecution,
    // ... å…¶ä»–æ–¹æ³•
  };
}
```

## ğŸ”„ æ•°æ®æµ

### æ¶ˆæ¯æµå›¾

```
ç”¨æˆ·è¾“å…¥ â†’ ä¹è§‚ UI â†’ API è·¯ç”± â†’ ä»£ç†æœåŠ¡ â†’ LangGraph ä»£ç†
    â†“                                                         â†“
React Query â†â”€ SSE æµ â†â”€ æµå¼å“åº” â†â”€ ä»£ç†æµ â†â”€â”˜
    â†“
UI æ›´æ–°
```

### è¯¦ç»†æµç¨‹æ­¥éª¤

1. **ç”¨æˆ·è¾“å…¥**
   - ç”¨æˆ·åœ¨ `MessageInput` ç»„ä»¶ä¸­è¾“å…¥æ¶ˆæ¯
   - è°ƒç”¨ `useChatThread.sendMessage()`

2. **ä¹è§‚ UI æ›´æ–°**
   - ç”¨æˆ·æ¶ˆæ¯ç«‹å³æ·»åŠ åˆ° React Query ç¼“å­˜
   - UI å³æ—¶æ›´æ–°ä»¥è·å¾—å“åº”æ„Ÿ

3. **API è¯·æ±‚**
   - æ‰“å¼€åˆ° `/api/agent/stream` çš„ SSE è¿æ¥
   - è¯·æ±‚åŒ…å«çº¿ç¨‹ IDã€æ¶ˆæ¯å†…å®¹å’Œé€‰é¡¹

4. **ä»£ç†å¤„ç†**
   - `streamResponse()` ç¡®ä¿çº¿ç¨‹å­˜åœ¨äºæ•°æ®åº“ä¸­
   - ä½¿ç”¨å½“å‰ MCP å·¥å…·å’Œé…ç½®åˆ›å»ºä»£ç†
   - LangGraph å¼€å§‹ä½¿ç”¨æ£€æŸ¥ç‚¹è¿›è¡ŒæŒä¹…åŒ–å¤„ç†

5. **å·¥å…·å®¡æ‰¹ï¼ˆå¦‚éœ€è¦ï¼‰**
   - å¦‚æœéœ€è¦å®¡æ‰¹ï¼Œä»£ç†åœ¨å·¥å…·è°ƒç”¨å¤„æš‚åœ
   - å·¥å…·è¯¦æƒ…é€šè¿‡ SSE å‘é€åˆ°å‰ç«¯
   - ç”¨æˆ·é€šè¿‡ UI æ‰¹å‡†/æ‹’ç»
   - å‘é€æ¢å¤å‘½ä»¤ä»¥ç»§ç»­å¤„ç†

6. **æµå¼å“åº”**
   - ä»£ç†å“åº”é€šè¿‡ SSE é€å—æµå¼ä¼ è¾“
   - å‰ç«¯æŒ‰æ¶ˆæ¯ ID ç´¯ç§¯å—
   - React Query ç¼“å­˜å®æ—¶æ›´æ–°

7. **æŒä¹…åŒ–**
   - æ‰€æœ‰æ¶ˆæ¯å­˜å‚¨åœ¨ LangGraph æ£€æŸ¥ç‚¹ä¸­
   - çº¿ç¨‹å…ƒæ•°æ®åœ¨ PostgreSQL ä¸­æ›´æ–°
   - MCP æœåŠ¡å™¨é…ç½®æŒä¹…åŒ–

## ğŸ—„ï¸ æ•°æ®åº“æ¨¡å¼

### å®ä½“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     çº¿ç¨‹        â”‚         â”‚   MCP æœåŠ¡å™¨    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: å­—ç¬¦ä¸² (PK) â”‚         â”‚ id: å­—ç¬¦ä¸² (PK) â”‚
â”‚ æ ‡é¢˜: å­—ç¬¦ä¸²    â”‚         â”‚ åç§°: å­—ç¬¦ä¸²    â”‚
â”‚ åˆ›å»ºæ—¶é—´: æ—¥æœŸ  â”‚         â”‚ ç±»å‹: æšä¸¾      â”‚
â”‚ æ›´æ–°æ—¶é—´: æ—¥æœŸ  â”‚         â”‚ å¯ç”¨: å¸ƒå°”      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ å‘½ä»¤: å­—ç¬¦ä¸²?   â”‚
                            â”‚ å‚æ•°: Json?     â”‚
                            â”‚ ç¯å¢ƒ: Json?     â”‚
                            â”‚ URL: å­—ç¬¦ä¸²?    â”‚
                            â”‚ å¤´ä¿¡æ¯: Json?   â”‚
                            â”‚ åˆ›å»ºæ—¶é—´: æ—¥æœŸ  â”‚
                            â”‚ æ›´æ–°æ—¶é—´: æ—¥æœŸ  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   LangGraph æ£€æŸ¥ç‚¹     â”‚
                    â”‚   ï¼ˆç”±æ¡†æ¶ç®¡ç†ï¼‰        â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ thread_id: å­—ç¬¦ä¸²       â”‚
                    â”‚ checkpoint_id: å­—ç¬¦ä¸²   â”‚
                    â”‚                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å¼è¯¦æƒ…

#### çº¿ç¨‹æ¨¡å‹

```prisma
model Thread {
  id        String   @id @default(uuid())
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**ç›®çš„**ï¼šå¯¹è¯çº¿ç¨‹çš„æœ€å°å…ƒæ•°æ®ã€‚å®é™…çš„å¯¹è¯å†å²å­˜å‚¨åœ¨ LangGraph æ£€æŸ¥ç‚¹ä¸­ä»¥å®ç°é«˜æ•ˆçš„çŠ¶æ€ç®¡ç†ã€‚

#### MCP æœåŠ¡å™¨æ¨¡å‹

```prisma
model MCPServer {
  id        String            @id @default(uuid())
  name      String            @unique
  type      MCPServerType     // stdio | http
  enabled   Boolean           @default(true)
  // ç”¨äº stdio æœåŠ¡å™¨
  command   String?
  args      Json?
  env       Json?
  // ç”¨äº http æœåŠ¡å™¨
  url       String?
  headers   Json?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}
```

**ç›®çš„**ï¼šMCP æœåŠ¡å™¨çš„åŠ¨æ€é…ç½®ã€‚æ”¯æŒå…·æœ‰çµæ´» JSON é…ç½®çš„ stdioï¼ˆå‘½ä»¤è¡Œï¼‰å’ŒåŸºäº HTTP çš„æœåŠ¡å™¨ã€‚

## ğŸ¤– ä»£ç†å·¥ä½œæµ

### StateGraph ç»“æ„

```
    å¼€å§‹
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»£ç†    â”‚ â”€â”€â–º ä½¿ç”¨å·¥å…·è°ƒç”¨è¯­è¨€æ¨¡å‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
  æ˜¯å¦åº”è¯¥
   å®¡æ‰¹å·¥å…·ï¼Ÿ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   æ˜¯    â”‚ â”€â”€â–º â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  å·¥å…·å®¡æ‰¹   â”‚ â”€â”€â–º äººå·¥å®¡æ ¸
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
   â”‚   å¦    â”‚              â–¼
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                â”‚  å·¥å…·   â”‚ â”€â”€â–º æ‰§è¡Œå·¥å…·
      â–¼                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ç»“æŸ                    â”‚
                           â–¼
                      è¿”å›ä»£ç†
```

### èŠ‚ç‚¹æè¿°

#### ä»£ç†èŠ‚ç‚¹

- **è¾“å…¥**ï¼šå½“å‰å¯¹è¯çŠ¶æ€
- **å¤„ç†**ï¼š
  - å°†ç³»ç»Ÿæç¤ºæ·»åŠ åˆ°æ¶ˆæ¯å†å²
  - å°†å¯ç”¨å·¥å…·ç»‘å®šåˆ°è¯­è¨€æ¨¡å‹
  - ç”Ÿæˆå¸¦æœ‰æ½œåœ¨å·¥å…·è°ƒç”¨çš„å“åº”
- **è¾“å‡º**ï¼šAI æ¶ˆæ¯ï¼ˆæ–‡æœ¬å’Œ/æˆ–å·¥å…·è°ƒç”¨ï¼‰

#### å·¥å…·å®¡æ‰¹èŠ‚ç‚¹

- **è¾“å…¥**ï¼šå¸¦æœ‰å·¥å…·è°ƒç”¨çš„ AI æ¶ˆæ¯
- **å¤„ç†**ï¼š
  - æ£€æŸ¥æ˜¯å¦å¯ç”¨ `approveAllTools`
  - å¦‚æœæœªå¯ç”¨ï¼Œä¸­æ–­å¹¶æä¾›å·¥å…·è¯¦æƒ…ä»¥ä¾›äººå·¥å®¡æ ¸
  - ç­‰å¾…ç”¨æˆ·å†³å®šï¼ˆå…è®¸/æ‹’ç»/ä¿®æ”¹ï¼‰
- **è¾“å‡º**ï¼šç»§ç»­åˆ°å·¥å…·æˆ–è¿”å›ä»£ç†çš„å‘½ä»¤

#### å·¥å…·èŠ‚ç‚¹

- **è¾“å…¥**ï¼šå·²æ‰¹å‡†çš„å·¥å…·è°ƒç”¨
- **å¤„ç†**ï¼šé€šè¿‡ MCP å®¢æˆ·ç«¯æ‰§è¡Œå·¥å…·
- **è¾“å‡º**ï¼šä½œä¸ºæ¶ˆæ¯çš„å·¥å…·ç»“æœ

### ä¸­æ–­å¤„ç†

```typescript
const humanReview = interrupt<
  { question: string; toolCall: ToolCall },
  { action: string; data: string | MessageContentComplex[] }
>({
  question: "Is this correct?",
  toolCall: toolCall,
});

switch (humanReview.action) {
  case "continue":
    return new Command({ goto: "tools" });
  case "update":
    return new Command({
      goto: "tools",
      update: { messages: [updatedMessage] },
    });
  case "feedback":
    return new Command({
      goto: "agent",
      update: { messages: [toolMessage] },
    });
}
```

## ğŸ”§ MCP é›†æˆ

### æœåŠ¡å™¨é…ç½®æµ

```
æ•°æ®åº“ MCPServer â†’ getMCPServerConfigs() â†’ MultiServerMCPClient â†’ ä»£ç†å·¥å…·
```

### é…ç½®ç¤ºä¾‹

#### Stdio æœåŠ¡å™¨ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰

```typescript
{
  name: "filesystem",
  type: "stdio",
  command: "npx",
  args: ["@modelcontextprotocol/server-filesystem", "/allowed/path"],
  env: { "LOG_LEVEL": "info" }
}
```

#### HTTP æœåŠ¡å™¨ï¼ˆè‡ªå®šä¹‰ APIï¼‰

```typescript
{
  name: "web-search",
  type: "http",
  url: "https://api.example.com/mcp",
  headers: {
    "Authorization": "Bearer token",
    "Content-Type": "application/json"
  }
}
```

### å·¥å…·åŠ è½½è¿‡ç¨‹

1. **æ•°æ®åº“æŸ¥è¯¢**ï¼šè·å–å¯ç”¨çš„ MCP æœåŠ¡å™¨
2. **å®¢æˆ·ç«¯åˆ›å»º**ï¼šåˆå§‹åŒ– MultiServerMCPClient
3. **å·¥å…·å‘ç°**ï¼šä»æ¯ä¸ªæœåŠ¡å™¨è·å–å¯ç”¨å·¥å…·
4. **åç§°å‰ç¼€**ï¼šæ·»åŠ æœåŠ¡å™¨åç§°å‰ç¼€ä»¥é˜²æ­¢å†²çª
5. **ä»£ç†ç»‘å®š**ï¼šå°†å·¥å…·ç»‘å®šåˆ°è¯­è¨€æ¨¡å‹

## âœ… å·¥å…·å®¡æ‰¹æµç¨‹

### ç”¨æˆ·ç•Œé¢æµ

```
æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ â†’ æ¸²æŸ“å®¡æ‰¹ UI â†’ ç”¨æˆ·å†³å®š â†’ å‘é€å‘½ä»¤ â†’ ä»£ç†æ¢å¤
```

### å®¡æ‰¹é€‰é¡¹

#### 1. å…è®¸

- **æ“ä½œ**ï¼šä½¿ç”¨åŸå§‹å‚æ•°æ‰§è¡Œå·¥å…·
- **å®ç°**ï¼š`new Command({ goto: "tools" })`
- **ç»“æœ**ï¼šå·¥å…·è¿è¡Œï¼Œä»£ç†ç»§ç»­ä½¿ç”¨ç»“æœ

#### 2. æ‹’ç»

- **æ“ä½œ**ï¼šè·³è¿‡å·¥å…·æ‰§è¡Œ
- **å®ç°**ï¼šè¿”å›å¸¦æœ‰æ‹’ç»æ¶ˆæ¯çš„ä»£ç†
- **ç»“æœ**ï¼šä»£ç†åœ¨æ²¡æœ‰å·¥å…·ç»“æœçš„æƒ…å†µä¸‹ç»§ç»­

#### 3. ä¿®æ”¹

- **æ“ä½œ**ï¼šåœ¨æ‰§è¡Œå‰ç¼–è¾‘å·¥å…·å‚æ•°
- **å®ç°**ï¼šä½¿ç”¨æ–°å‚æ•°æ›´æ–°æ¶ˆæ¯
- **ç»“æœ**ï¼šå·¥å…·ä½¿ç”¨ä¿®æ”¹åçš„è¾“å…¥è¿è¡Œ

### å‰ç«¯å®ç°

```typescript
const approveToolExecution = useCallback(
  async (toolCallId: string, action: "allow" | "deny") => {
    await handleStreamResponse({
      threadId,
      text: "",
      opts: { allowTool: action },
    });
  },
  [threadId, handleStreamResponse],
);
```

## ğŸŒŠ æµå¼æ¶æ„

### æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆSSEï¼‰æµ

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ API è·¯ç”± â†’ ä»£ç†æµ â†’ SSE å“åº” â†’ å®¢æˆ·ç«¯å¤„ç†ç¨‹åº
```

### æ¶ˆæ¯å¤„ç†

#### æœåŠ¡å™¨ç«¯ (`/api/agent/stream/route.ts`)

```typescript
export async function POST(request: Request) {
  const stream = new ReadableStream({
    async start(controller) {
      try {
        const responseGenerator = streamResponse(params);

        for await (const messageResponse of responseGenerator) {
          const data = JSON.stringify(messageResponse);
          controller.enqueue(new TextEncoder().encode(`data: ${data}\n\n`));
        }

        controller.enqueue(new TextEncoder().encode(`event: done\ndata: {}\n\n`));
      } catch (error) {
        controller.enqueue(
          new TextEncoder().encode(
            `event: error\ndata: ${JSON.stringify({ message: error.message })}\n\n`,
          ),
        );
      } finally {
        controller.close();
      }
    },
  });

  return new Response(stream, {
    headers: {
      "Content-Type": "text/event-stream",
      "Cache-Control": "no-cache",
      Connection: "keep-alive",
    },
  });
}
```

#### å®¢æˆ·ç«¯ (`useChatThread.ts`)

```typescript
stream.onmessage = (event: MessageEvent) => {
  const messageResponse = JSON.parse(event.data) as MessageResponse;
  const data = messageResponse.data as AIMessageData;

  // ç¬¬ä¸€å—ï¼šåˆ›å»ºæ–°æ¶ˆæ¯
  if (!currentMessageRef.current || currentMessageRef.current.data.id !== data.id) {
    currentMessageRef.current = messageResponse;
    queryClient.setQueryData(["messages", threadId], (old: MessageResponse[] = []) => [
      ...old,
      messageResponse,
    ]);
  } else {
    // ç´¯ç§¯å—
    currentMessageRef.current = {
      ...currentMessageRef.current,
      data: {
        ...currentMessageRef.current.data,
        content: currentMessageRef.current.data.content + data.content,
      },
    };
    queryClient.setQueryData(["messages", threadId], (old: MessageResponse[] = []) => {
      const newMessages = [...old];
      newMessages[newMessages.length - 1] = currentMessageRef.current!;
      return newMessages;
    });
  }
};
```

## âŒ é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹

#### 1. ç½‘ç»œé”™è¯¯

- **SSE è¿æ¥å¤±è´¥**ï¼šè‡ªåŠ¨é‡è¿ï¼ŒæŒ‡æ•°é€€é¿
- **API è¶…æ—¶**ï¼šç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
- **æœåŠ¡å™¨ä¸å¯ç”¨**ï¼šç¦»çº¿æ¨¡å¼æŒ‡ç¤ºå™¨

#### 2. ä»£ç†é”™è¯¯

- **å·¥å…·æ‰§è¡Œå¤±è´¥**ï¼šä¼˜é›…é™çº§ï¼Œç”¨æˆ·é€šçŸ¥
- **æ¨¡å‹ API é”™è¯¯**ï¼šå›é€€æ¨¡å‹ï¼Œé€Ÿç‡é™åˆ¶å¤„ç†
- **MCP æœåŠ¡å™¨é”™è¯¯**ï¼šéš”ç¦»çš„æœåŠ¡å™¨æ•…éšœ

#### 3. æ•°æ®åº“é”™è¯¯

- **è¿æ¥å¤±è´¥**ï¼šè¿æ¥æ± é‡è¯•
- **æŸ¥è¯¢è¶…æ—¶**ï¼šæŸ¥è¯¢ä¼˜åŒ–ï¼Œç´¢å¼•
- **æ•°æ®éªŒè¯**ï¼šæ¨¡å¼éªŒè¯ï¼Œæ¸…ç†

### é”™è¯¯è¾¹ç•Œ

```typescript
// ç»„ä»¶çº§é”™è¯¯è¾¹ç•Œ
export function ErrorBoundary({ children }: { children: React.ReactNode }) {
  return (
    <ErrorBoundaryComponent
      fallback={({ error }) => <ErrorMessage error={error} />}
    >
      {children}
    </ErrorBoundaryComponent>
  );
}

// API çº§é”™è¯¯å¤„ç†
export async function handleApiError(error: unknown) {
  if (error instanceof ZodError) {
    return NextResponse.json({ error: "Validation error", details: error.errors }, { status: 400 });
  }
  
  if (error instanceof DatabaseError) {
    logger.error("Database error", error);
    return NextResponse.json({ error: "Database error" }, { status: 500 });
  }
  
  logger.error("Unexpected error", error);
  return NextResponse.json({ error: "Internal server error" }, { status: 500 });
}
```

## âš¡ æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–ç­–ç•¥

#### 1. å‰ç«¯ä¼˜åŒ–

- **React Query ç¼“å­˜**ï¼šæ™ºèƒ½ç¼“å­˜å¤±æ•ˆï¼Œåå°åˆ·æ–°
- **ä»£ç åˆ†å‰²**ï¼šåŠ¨æ€å¯¼å…¥ï¼ŒåŸºäºè·¯ç”±çš„åˆ†å‰²
- **å›¾åƒä¼˜åŒ–**ï¼šNext.js å›¾åƒç»„ä»¶ï¼Œæ‡’åŠ è½½
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šå¤§å‹æ¶ˆæ¯åˆ—è¡¨

#### 2. åç«¯ä¼˜åŒ–

- **è¿æ¥æ± **ï¼šæ•°æ®åº“è¿æ¥é‡ç”¨
- **å“åº”ç¼“å­˜**ï¼šAPI å“åº”ç¼“å­˜
- **æµå¼å¤„ç†**ï¼šå‡å°‘å†…å­˜ä½¿ç”¨
- **æ•°æ®åº“ç´¢å¼•**ï¼šæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

#### 3. AI/ä»£ç†ä¼˜åŒ–

- **æ¨¡å‹ç¼“å­˜**ï¼šé‡ç”¨é…ç½®çš„ä»£ç†
- **å·¥å…·ç¼“å­˜**ï¼šç¼“å­˜ MCP å·¥å…·å®šä¹‰
- **æµå¼å“åº”**ï¼šå‡å°‘æ„ŸçŸ¥å»¶è¿Ÿ
- **æ™ºèƒ½é‡è¯•**ï¼šæŒ‡æ•°é€€é¿ï¼Œæ–­è·¯å™¨

### ç›‘æ§æŒ‡æ ‡

#### å…³é”®æŒ‡æ ‡

- **å“åº”æ—¶é—´**ï¼šAPI å“åº”æ—¶é—´ï¼Œä»£ç†å¤„ç†æ—¶é—´
- **é”™è¯¯ç‡**ï¼šAPI é”™è¯¯ï¼Œä»£ç†å¤±è´¥ï¼Œå·¥å…·é”™è¯¯
- **èµ„æºä½¿ç”¨**ï¼šCPUï¼Œå†…å­˜ï¼Œæ•°æ®åº“è¿æ¥
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ¶ˆæ¯å‘é€æ—¶é—´ï¼Œå·¥å…·å®¡æ‰¹æ—¶é—´

#### ç›‘æ§å·¥å…·

```typescript
// æ€§èƒ½ç›‘æ§
export function trackPerformance<T>(
  name: string,
  fn: () => Promise<T>
): Promise<T> {
  const start = performance.now();
  
  return fn().finally(() => {
    const duration = performance.now() - start;
    metrics.histogram(`performance.${name}`, duration);
    
    if (duration > 1000) {
      logger.warn(`Slow operation: ${name} took ${duration}ms`);
    }
  });
}

// é”™è¯¯è·Ÿè¸ª
export function trackError(error: Error, context?: Record<string, unknown>) {
  metrics.increment("errors.total");
  logger.error("Application error", { error, context });
  
  // å‘é€åˆ°é”™è¯¯è·Ÿè¸ªæœåŠ¡
  errorTracker.captureException(error, {
    extra: context,
  });
}
```

### æ‰©å±•è€ƒè™‘

#### æ°´å¹³æ‰©å±•

- **æ— çŠ¶æ€è®¾è®¡**ï¼šAPI è·¯ç”±ä¸ç»´æŠ¤çŠ¶æ€
- **æ•°æ®åº“æ‰©å±•**ï¼šè¯»å–å‰¯æœ¬ï¼Œåˆ†ç‰‡
- **ç¼“å­˜å±‚**ï¼šRedis ç”¨äºä¼šè¯æ•°æ®
- **è´Ÿè½½å‡è¡¡**ï¼šå¤šä¸ªæœåŠ¡å™¨å®ä¾‹

#### å‚ç›´æ‰©å±•

- **èµ„æºä¼˜åŒ–**ï¼šé«˜æ•ˆçš„ç®—æ³•ï¼Œå†…å­˜ç®¡ç†
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šæŸ¥è¯¢ä¼˜åŒ–ï¼Œç´¢å¼•ç­–ç•¥
- **ç¼“å­˜ç­–ç•¥**ï¼šå¤šå±‚ç¼“å­˜ï¼ŒCDN
- **å¼‚æ­¥å¤„ç†**ï¼šåå°ä»»åŠ¡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—

---

*æœ¬æ¶æ„æ–‡æ¡£ä¼šéšç³»ç»Ÿå‘å±•è€Œæ›´æ–°ã€‚æœ‰å…³è´¡çŒ®å’Œæ›´æ–°ï¼Œè¯·å‚é˜…é¡¹ç›® READMEã€‚*
